<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title></title>
    <link rel="stylesheet" href="css/normalize.css">
    <link rel="stylesheet" href="css/swiper.min.css">
    <link rel="stylesheet" href="css/index.css">
</head>

<body>
    <div id="root">
        <div class="main">
            <div :class="[index === currPlay ? 'on-channel' : '']" @click="handleChannel(index, $event)" ref="channel"
                :data-channel="channel.channelname" class="channel" v-for="(channel, index) in playchannel" :key="index">
                <template v-if="index === currPlay">
                    <div :class="[cindex === indexD ? 'on-contents': '']" :data-title="child.title" class="section"
                        v-for="(child, cindex) in channel.contents" :key="cindex">
                        <!-- 纯图片 -->
                        <template v-if="child.showtype === 3">
                            <div class="swiper-container">
                                <div class="swiper-wrapper">
                                    <div class="swiper-slide" v-for="(slide, index) in child.images" :key="index">
                                        <img :src="slide.imageurl" alt="">
                                    </div>
                                </div>
                            </div>
                        </template>
                        <!-- 纯图片 -->
                        <!-- 上视频下图片 -->
                        <template v-if="child.showtype === 4">
                            <div class="video">
                                <video :src="child.video.videourl" height="300" loop autoplay controls></video>
                            </div>
                            <div class="swiper-container">
                                <div class="swiper-wrapper">
                                    <div class="swiper-slide" v-for="(slide, index) in child.images" :key="index">
                                        <img :src="slide.imageurl" alt="">
                                    </div>
                                </div>
                            </div>
                        </template>
                        <!-- 上视频下图片 -->
                        <!-- 上图片下视频 -->
                        <template v-if="child.showtype === 5">
                            <div class="swiper-container">
                                <div class="swiper-wrapper">
                                    <div class="swiper-slide" v-for="(slide, index) in child.images" :key="index">
                                        <img :src="slide.imageurl" alt="">
                                    </div>
                                </div>
                            </div>
                            <div class="video">
                                <video :src="child.video.videourl" height="300" loop autoplay controls></video>
                            </div>
                        </template>
                        <!-- 上图片下视频 -->
                    </div>
                </template>
            </div>
        </div>
    </div>
</body>
<script src="./js/vue.min.js"></script>
<script src="./js/axios.min.js"></script>
<script src="./js/swiper.min.js"></script>
<script>
    const vm = new Vue({
        el: "#root",
        data: {
            currPlaying: -1,
            currPlay: -1, // 当前播放的栏目
            currPlayCon: 0, //当前播放的内容
            contentsLen: 0,
            timer: null,
            timerC: null,
            indexD: 0,
            duration: 0,
            playchannel: [], //播放数据 
        },
        computed: {
            full: function () {

            }
        },
        methods: {
            handleChannel: function (index) {

            },
            //补0操作
            fill: function (i) {
                if (i >= 1 && i <= 9) {
                    i = "0" + i;
                }
                return i;
            },
            //获取本地年月日时分秒
            getNowDate(arg) {
                var d = new Date();
                //年
                var year = d.getFullYear();
                //月
                var mouth = this.fill(d.getMonth() + 1);
                //日
                var day = this.fill(d.getDate());
                //时
                var hours = this.fill(d.getHours());
                //分
                var minutes = this.fill(d.getMinutes());
                //秒
                var seconds = this.fill(d.getSeconds());

                if (arg && arg === 1) {
                    return year + "-" + mouth + "-" + day;
                } else {
                    return hours + ":" + minutes + ":" + seconds;
                }
            },
            //计算时间差
            getDateDiff: function (now, end) {
                var e = new Date(end);
                var d = e.getTime() - now; //时间差的毫秒数
                if (d < 0) {
                    console.log("播放的栏目结束了")
                    this.currPlay = -1;
                    clearInterval(this.timer);
                } else {
                    //console.log("播放的栏目还在走着");
                    //计算出相差天数
                    let days = Math.floor(d / (24 * 3600 * 1000))
                    var leave1 = d % (24 * 3600 * 1000) //计算天数后剩余的毫秒数
                    var hours = Math.floor(leave1 / (3600 * 1000))
                    //计算相差分钟数
                    var leave2 = leave1 % (3600 * 1000) //计算小时数后剩余的毫秒数
                    var minutes = Math.floor(leave2 / (60 * 1000))
                    //计算相差秒数
                    var leave3 = leave2 % (60 * 1000) //计算分钟数后剩余的毫秒数
                    var seconds = Math.round(leave3 / 1000)
                    //console.log(days + "天" + hours + "小时" + minutes + "分钟" + seconds + "秒");
                }
            },
            //播放栏目
            runPlayChannel: function () {
                var that = this;
                var playchannel = this.playchannel;
                var ymd = this.getNowDate(1);
                var hms = this.getNowDate();
                var priorityArr = [];
                for (let i = 0; i < playchannel.length; i++) {
                    var channels = playchannel[i]; //每个栏目
                    var validstarttime = channels.validstarttime;
                    var validendtime = channels.validendtime;
                    var playstarttime = channels.playstarttime;
                    var playendtime = channels.playendtime;
                    //如果今天有要播放的栏目
                    if (ymd == validstarttime) {
                        //当前时间hh:mm:ss是否在播放开始时间和结束时间内
                        if (hms >= playstarttime && hms <= playendtime) {
                            //如果存在多个栏目，那么保存栏目优先级
                            //console.log(channels)
                            priorityArr.push(channels.priority);
                        }
                    }
                }
                if (priorityArr.length) {
                    //简单的排序
                    var last = priorityArr.sort();
                    var copy = [];
                    var c;
                    //找出优先级最高的栏目
                    playchannel.forEach(function (elem, index) {
                        if (elem.priority === last[last.length - 1]) {
                            copy.push(elem);
                        }
                    });
                    //说明有多个优先级一样的栏目
                    if (copy.length > 1) {
                        //那么就取第一个栏目播放
                        c = copy[0];
                    } else {
                        c = copy[0];
                    }
                    this.currPlay = playchannel.findIndex(function (elem) {
                        return elem.channelname === c.channelname;
                    });

                    if (this.currPlaying == this.currPlay) {
                        return;
                    } else {
                        this.currPlaying = this.currPlay;
                        this.runPlayChannelContents(c.contents);
                    }

                }
            },
            //播放栏目的内容
            runPlayChannelContents(contents) {
                var that = this;
                var durationArr = []
                for (var i = 0; i < contents.length; i++) {
                    var con = contents[i];
                    durationArr.push(con.duration);
                }
                this.contentsLen = durationArr.length;
                if (durationArr.length > 0) {
                    this.indexD = 0;
                    this.duration = durationArr[this.indexD]
                    if (this.timerC != null) {
                        clearInterval(this.timerC);
                        this.indexD = 0;
                    }
                    this.timerC = setInterval(function () {
                        that.changeImg(durationArr);
                    }, 2000);
                    console.log("timerc:" + this.timerC);
                }
            },
            changeImg: function (durationArr) {
                if (this.duration > 0) {
                    this.duration = this.duration - 2;
                    console.log(this.duration);
                } else {
                    if (this.indexD < this.contentsLen) {
                        this.indexD++;
                        this.duration = durationArr[this.indexD];
                    } else {
                        //clearInterval(this.timerC);
                        this.indexD = 0;
                        this.duration = durationArr[this.indexD];
                    }

                }
            },
            //获取学校播放列表
            getPlayChannel: function () {
                var that = this;
                axios.get('./channels.json', {}).then(function (response) {
                    that.$nextTick(function () {
                        that.playchannel = response.data.playchannel;
                        this.runPlayChannel();
                    });
                }).catch(function (error) {
                    return error;
                })
            },
            swiperInit: function () {
                var mySwiper = new Swiper('.swiper-container', {
                    autoplay: {
                        delay: 5000,
                    },
                    //loop: true,
                })
            },
        },
        mounted: function () {
            var that = this;
            this.getPlayChannel();

            //定时器
            /*
                        this.timer = setInterval(function () {
                            that.getDateDiff(Date.now(), ymd + " " + c.playendtime);
                        }, 1000);
            */
            setInterval(function () {
                //console.log(11);
                that.runPlayChannel()
            }, 5000)
        },
        updated: function () {
            this.swiperInit();
        },
    });
</script>

</html>